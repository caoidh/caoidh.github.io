import React, { useState, useEffect } from 'react';
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

const Dashboard = () => {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [activeTab, setActiveTab] = useState('cashier');
  const [cart, setCart] = useState([]);
  const [history, setHistory] = useState([]);
  const [productName, setProductName] = useState('');
  const [productPrice, setProductPrice] = useState('');
  const [productQuantity, setProductQuantity] = useState(1);
  
  // Пользователи для авторизации
  const users = [
    { username: 'admin', password: 'admin123', name: 'Администратор' },
    { username: 'cashier', password: 'cash123', name: 'Кассир' }
  ];

  useEffect(() => {
    const savedHistory = localStorage.getItem('cashierHistory');
    if (savedHistory) {
      setHistory(JSON.parse(savedHistory));
    }
  }, []);

  const login = (username, password) => {
    const user = users.find(u => u.username === username && u.password === password);
    if (user) {
      setCurrentUser(user);
      setIsLoggedIn(true);
      return true;
    }
    return false;
  };

  const logout = () => {
    setCurrentUser(null);
    setIsLoggedIn(false);
    setCart([]);
  };

  const addToCart = () => {
    if (!productName || !productPrice || !productQuantity) {
      alert('Пожалуйста, заполните все поля');
      return;
    }
    
    setCart([...cart, {
      name: productName,
      price: parseFloat(productPrice),
      quantity: parseInt(productQuantity)
    }]);
    
    setProductName('');
    setProductPrice('');
    setProductQuantity(1);
  };

  const removeFromCart = (index) => {
    const newCart = cart.filter((_, i) => i !== index);
    setCart(newCart);
  };

  const checkout = () => {
    if (cart.length === 0) {
      alert('Корзина пуста');
      return;
    }

    const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const newRecord = {
      date: new Date().toISOString(),
      total,
      items: [...cart],
      cashier: currentUser.name
    };

    const newHistory = [...history, newRecord];
    setHistory(newHistory);
    localStorage.setItem('cashierHistory', JSON.stringify(newHistory));
    setCart([]);
    alert('Чек оформлен успешно!');
  };

  // Подготовка данных для графиков
  const getSalesData = () => {
    const dailyTotals = {};
    history.forEach(record => {
      const date = new Date(record.date).toLocaleDateString();
      dailyTotals[date] = (dailyTotals[date] || 0) + record.total;
    });
    return Object.entries(dailyTotals).map(([date, total]) => ({
      date,
      total
    }));
  };

  const getProductStats = () => {
    const stats = {};
    history.forEach(record => {
      record.items.forEach(item => {
        stats[item.name] = (stats[item.name] || 0) + (item.price * item.quantity);
      });
    });
    return Object.entries(stats).map(([name, total]) => ({
      name,
      total
    }));
  };

  if (!isLoggedIn) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-gray-100">
        <div className="w-full max-w-md p-6 bg-white rounded-lg shadow-md">
          <h2 className="text-2xl font-bold mb-6 text-center">Вход в систему</h2>
          <form onSubmit={(e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const success = login(formData.get('username'), formData.get('password'));
            if (!success) alert('Неверные учетные данные');
          }}>
            <div className="mb-4">
              <label className="block text-gray-700 mb-2">Логин:</label>
              <input
                name="username"
                type="text"
                className="w-full p-2 border rounded"
                required
              />
            </div>
            <div className="mb-6">
              <label className="block text-gray-700 mb-2">Пароль:</label>
              <input
                name="password"
                type="password"
                className="w-full p-2 border rounded"
                required
              />
            </div>
            <button
              type="submit"
              className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
            >
              Войти
            </button>
          </form>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-3xl font-bold">Онлайн-касса</h1>
          <div className="flex items-center gap-4">
            <span>{currentUser.name}</span>
            <button
              onClick={logout}
              className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
            >
              Выйти
            </button>
          </div>
        </div>

        <div className="flex gap-4 mb-6">
          <button
            className={`px-4 py-2 rounded ${activeTab === 'cashier' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
            onClick={() => setActiveTab('cashier')}
          >
            Касса
          </button>
          <button
            className={`px-4 py-2 rounded ${activeTab === 'history' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
            onClick={() => setActiveTab('history')}
          >
            История
          </button>
          <button
            className={`px-4 py-2 rounded ${activeTab === 'analytics' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
            onClick={() => setActiveTab('analytics')}
          >
            Аналитика
          </button>
        </div>

        {activeTab === 'cashier' && (
          <div className="bg-white p-6 rounded-lg shadow mb-6">
            <div className="grid grid-cols-4 gap-4 mb-6">
              <input
                type="text"
                value={productName}
                onChange={(e) => setProductName(e.target.value)}
                placeholder="Название товара"
                className="p-2 border rounded"
              />
              <input
                type="number"
                value={productPrice}
                onChange={(e) => setProductPrice(e.target.value)}
                placeholder="Цена"
                className="p-2 border rounded"
              />
              <input
                type="number"
                value={productQuantity}
                onChange={(e) => setProductQuantity(e.target.value)}
                placeholder="Количество"
                className="p-2 border rounded"
              />
              <button
                onClick={addToCart}
                className="bg-green-500 text-white p-2 rounded hover:bg-green-600"
              >
                Добавить
              </button>
            </div>

            <table className="w-full mb-6">
              <thead>
                <tr className="border-b">
                  <th className="text-left p-2">Товар</th>
                  <th className="text-left p-2">Цена</th>
                  <th className="text-left p-2">Количество</th>
                  <th className="text-left p-2">Сумма</th>
                  <th className="text-left p-2">Действия</th>
                </tr>
              </thead>
              <tbody>
                {cart.map((item, index) => (
                  <tr key={index} className="border-b">
                    <td className="p-2">{item.name}</td>
                    <td className="p-2">{item.price.toFixed(2)} ₽</td>
                    <td className="p-2">{item.quantity}</td>
                    <td className="p-2">{(item.price * item.quantity).toFixed(2)} ₽</td>
                    <td className="p-2">
                      <button
                        onClick={() => removeFromCart(index)}
                        className="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"
                      >
                        Удалить
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>

            <div className="flex justify-between items-center">
              <div className="text-xl font-bold">
                Итого: {cart.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2)} ₽
              </div>
              <button
                onClick={checkout}
                className="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600"
              >
                Оформить чек
              </button>
            </div>
          </div>
        )}

        {activeTab === 'history' && (
          <div className="bg-white p-6 rounded-lg shadow">
            <table className="w-full">
              <thead>
                <tr className="border-b">
                  <th className="text-left p-2">Дата</th>
                  <th className="text-left p-2">Сумма</th>
                  <th className="text-left p-2">Товары</th>
                  <th className="text-left p-2">Кассир</th>
                </tr>
              </thead>
              <tbody>
                {history.map((record, index) => (
                  <tr key={index} className="border-b">
                    <td className="p-2">{new Date(record.date).toLocaleString()}</td>
                    <td className="p-2">{record.total.toFixed(2)} ₽</td>
                    <td className="p-2">{record.items.map(item => `${item.name} (${item.quantity}шт)`).join(', ')}</td>
                    <td className="p-2">{record.cashier}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {activeTab === 'analytics' && (
          <div className="space-y-6">
            <div className="bg-white p-6 rounded-lg shadow">
              <h3 className="text-xl font-bold mb-4">Динамика продаж</h3>
              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={getSalesData()}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="date" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Line type="monotone" dataKey="total" stroke="#2563eb" name="Сумма продаж" />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </div>

            <div className="bg-white p-6 rounded-lg shadow">
              <h3 className="text-xl font-bold mb-4">Продажи по товарам</h3>
              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={getProductStats()}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Bar dataKey="total" fill="#2563eb" name="Сумма продаж" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default Dashboard;
